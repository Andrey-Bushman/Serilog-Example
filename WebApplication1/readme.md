
# WebApplication1

Проект создан на основе шаблона `ASP.NET Core Web API`.

В данном приложении приводится пример работы с логом посредством интерфейса `Microsoft.Extensions.Logging.ILogger<T>`,
определённого в составе NuGet-пакета `Microsoft.Extensions.Logging.Abstractions`. При этом _"под капотом"_ в качестве
реализации этих абстракций используется `Serilog`.

Обратите внимание на то, что в коде используются _исключительно абстракции_, определённые в сборке `Microsoft.Extensions.Logging.Abstractions`.
Это означает, что заменив логгер `Serilog` на какой-либо другой, ваш код продолжит работать (_при условии, что тот логгер, на который вы
переключились, так же реализовывает эти стандартные абстракции_).

## Настройки логгера

Все настройки логгера указаны в конфигурационном файле `appsettings.json`. В блоке `Logging > LogLevel` можно указывать
минимальный уровень логирования для каждой интересующей вас _категории логгера_ индивидуально (в качестве имени категории
используется полное имя типа, указанного вами в качестве `T` в `ILogger<T>`). Т.о. вы можете управлять уровнем логирования для
каждой категории индивидуально.

Чтобы не указывать одинаковые настройки отдельно для каждой категории логгера, в имени категории можно использовать подстановочные знаки.
Например: `WebApplication1.*`.

При использовании `Serilog` настройки уровней логирования для различных категорий логгера хранятся не в секции `Logging > LogLevel`,
но в `Serilog > MinimumLevel`.

Используемые _приёмники логов_ подключаются в секции `Serilog > Using` (после подключения к проекту NuGet-пакета, одноимённого
добавляемому приёмнику). Конфигурирование каждого приёмника логов выполняется в секции `Serilog > WriteTo`.

В настройке `Logging > LogLevel > Default` указывается значение, используемое по умолчанию.

## Правила использования логгера

Примеры использования логгера (_с поясняющими комментариями_) смотрите в файле `WeatherForecastController.cs`.

  1. Используйте _структурированный_ лог. Для этого все операции логирования выполняйте в рамках `Scope`, создаваемого вами в блоке `using`
     при помощи вызова метода `ILogger<T>.BeginScope(obj)`. Свойства и значения произвольного объекта `obj` будут добавлены в каждую запись
     лога, выполняемую в рамках данного блока `using`. Такие блоки могут быть вложенными. В тексте сообщения лога вы можете использоват значения
     свойств объекта `obj`: для этого вам нужно в фигурных скобках указать имя соответствующего свойства объекта `obj`.
     Например: `"Имя пользователя: {UserName}"`. Свойства структурированного лога доступны для поиска и сортировки в таких приложениях,
     как [Seq](https://datalust.co/seq).
  1. Свойства структурированного лога не записываются автоматически в текстовый файл. Поэтому для логирования в файлы в настройках `appsettings.json`
     следует указать нужный вам шаблон формирования текстовых сообщений. Делается это в настройке `Serilog > WriteTo > [outputTemplate]`. При этом вам
     доступны пользовательские свойства, программно определённые вами в коде в рамках `scope`.
  1. Если вы в коде файла `Program.cs` закомментируете вызов `builder.Host.UseSerilog()`, то в соответствии с текущими настройками
     файла `appsettings.json`, будет использоваться стандартный логгер от Майкрософт, который будет писать логи только в консоль и в журнал Windows.
     При этом те настройки, которые вы указали для `Serilog`, при формировании сообщений применяться не будут, а в журнале Windows в качестве _Источника_
     для добавляемых вами записей будет указываться _.NET Runtime_.

## Установка Seq

В данном приложении в качестве одного из приёмников лога используется приложение [Seq](https://datalust.co/seq). Поэтому скачайте и установите
его на вашем локальном компьютере, прежде чем будете запускать приложение **WebApplication1**.
Запустив приложение **Seq** вы можете посмотреть логи по адресу <http://localhost:5341/#/events>.

## Запуск

Не забудьте предварительно установить [Seq](https://datalust.co/seq). Первый запуск приложения **WebApplication1** следует выполнять с правами администратора.
Это необходимо для того, чтобы в **События Windows** смог быть добавлен новый _Источник событий_ = **WebApplication1**. Последующие запуски приложения
можно выполнять без административных прав.

Приложение **WebApplication1** пишет логи в следующие приёмники:

  * **Консоль**
  * **События Windows**: _Журналы Windows > Приложение_ (фильтровать по _Источник событий_ = **WebApplication1**)
  * **Файл** с заданным для него пользовательским шаблоном формирования сообщений (
    _на каждый день свой файл, не превышающий заданный вами размер, с автоматическим удалением старых файлов при превышении заданного вами количества файлов_)
  * [Seq](https://datalust.co/seq) (структурированный лог с гибкими возможностями поиска, сортировки и обработки данных)